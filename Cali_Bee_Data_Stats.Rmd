---
title: "Cali_Bee_Data_Stats"
author: "JT_Miller"
date: "1/20/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

### The goal of this Rmarkdown is to identify Summary Statistics for a data acquisition from GBIF on all Bee Families from California

### The citation for this data acquisition can be found here: GBIF.org (20 January 2022) GBIF Occurrence Download https://doi.org/10.15468/dl.d3d45v

#### Loading in Libraries
```{r}
library(sf)
library(leaflet)
#library(rgdal)
#library(leafgl)
#library(sp)
library(tidyverse)
```

### Loading in Bee Data for all occurrence data from all bee families in the USA
```{r}
united_states_bees <- read.delim(file="C:/Users/JTroo/Desktop/L/2022_dataset/bee_occurrence3.txt",header=TRUE)


```

### Bringing in some necessary shape files to bound the Occurrence data to California Specifically
```{r}
cali_map <- sf::read_sf("filter_polygon/cali_ecoregions_3/ca_eco_l3.shp") %>% 
  sf::st_transform('+proj=longlat +datum=WGS84')
```

### Giving occurrence data a crs to work with
```{r}
united_states_bees_w_crs <- st_as_sf(united_states_bees, coords = c('decimalLongitude', 'decimalLatitude'), crs = 4326, na.fail = FALSE, remove = FALSE)
```

### Bounding data by California shp file 
```{r}
cali_bees <- united_states_bees_w_crs[cali_map,]

cali_bees <- cali_bees %>%
  dplyr::mutate(decimalLatitude = sf::st_coordinates(.)[,2],
                decimalLongitude = sf::st_coordinates(.)[,1])
```
### First Lets split specimens, observations, and unknowns into 3 groups
```{r}
specimens <- cali_bees %>% 
  filter(basisOfRecord == "PRESERVED_SPECIMEN" | basisOfRecord == "FOSSIL_SPECIMEN" | basisOfRecord == "MATERIAL_SAMPLE")
  
  
observations <- cali_bees %>% 
  filter(basisOfRecord == "HUMAN_OBSERVATION" | basisOfRecord == "MACHINE_OBSERVATION")
unknowns <- cali_bees %>% 
  filter(basisOfRecord == "UNKNOWN")
```

### Percent of specimens georeferenced 
```{r}
specimens_w_coords <- subset(specimens, !is.na(decimalLongitude) & !is.na(decimalLatitude))
percent_specimen_w_coords <- (nrow(specimens_w_coords)/nrow(specimens)) * 100
print(percent_specimen_w_coords) 
# Wellllll this seems unlikely...possible that assigning a CRS to the occurrence data removes anything without a lon lat coord...
cali_bees_w_coords <- subset(cali_bees, !is.na(decimalLongitude) & !is.na(decimalLatitude))
percent_cali_bees_w_coords <- (nrow(cali_bees_w_coords)/nrow(cali_bees)) * 100
print(percent_cali_bees_w_coords)
### So one of two things, either our bounding method eliminates all values that do not have coordinates (very likely) or california has all georeferenced data (very unlikely)
united_states_bees_w_crs_coords <- subset(united_states_bees_w_crs, !is.na(decimalLongitude) & !is.na(decimalLatitude))
united_states_bees_w_crs_coords <- (nrow(united_states_bees_w_crs_coords)/nrow(united_states_bees_w_crs)) * 100
print(united_states_bees_w_crs_coords)
```
### How many genera and species per family in california for Specimens
```{r}
specimens_apidae_genus <- specimens %>% 
  dplyr::filter(family == "Apidae") %>%
  group_by(genus) %>% 
  dplyr::distinct(genus, .keep_all = TRUE)

unique(specimens_apidae_genus$genus) # It seems that row 19 is a blank ID, therefore lets get rid of it. 


genus_simplifier <- function(data, family=NULL, distincter=NULL){ #Make a genus simplifier function
  if(!is.null(family)){
    data <- data[data$family %in% family,]
  }
  if(is.null(distincter)){
    data <- data %>% 
      dplyr::group_by(genus) %>% 
      dplyr::distinct(genus, .keep_all=TRUE)
      
  }
  return(data)
}



specimens_apidae_genus_test <- genus_simplifier(specimens, family = "Apidae") #Check works
####################### First Drop empty spaces that show up in each genus grouping: The resultant genera outputs should be apidae=48, colletidae=19, halictidae=24, megachilidae=24, melittidae=2 ###############################

specimens <- specimens[!(specimens$genus==""),] #Remove all rows that have an empty space filled for specimens

####################### Genera per Family specimens #######################################
specimens_apidae_genera <- genus_simplifier(specimens, family = "Apidae")
specimens_colletidae_genera <- genus_simplifier(specimens, family = "Colletidae")
specimens_andrenidae_genera <- genus_simplifier(specimens, family = "Andrenidae")
specimens_halictidae_genera <- genus_simplifier(specimens, family = "Halictidae")
specimens_megachilidae_genera <- genus_simplifier(specimens, family = "Megachilidae")
specimens_melittidae_genera <- genus_simplifier(specimens, family = "Melittidae")

```

# Assigning values based on unique genera per family 
```{r}
####################### Assign values of genera per family ###############################
nrow(specimens_apidae_genera)
nrow(specimens_colletidae_genera)
nrow(specimens_andrenidae_genera)
nrow(specimens_halictidae_genera)
nrow(specimens_megachilidae_genera)
nrow(specimens_melittidae_genera)
###################### Create a vector of family names ###################################
bee_families <- c("Apidae", "Collentidae", "Andrenidae", "Halictidae", "Megachilidae", "Melittidae")

###################### Create a vector with number of unique genera per family ###########
specimens_generas_v <- c(48,3,13,24,24,2)

###################### Data Frame ########################################################

specimens_genera_p_fams <- data.frame(bee_families, specimens_generas_v)

###################### GGPlot it #########################################################
ggplot(data = specimens_genera_p_fams, aes(x = bee_families, y = specimens_generas_v)) +
  geom_col() +
  xlab("Bee Family") +
  ylab("Unique Genera") +
  ggtitle("Genera Composition of Bee specimens in California") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))
```

### Repeated for Observations
```{r}
# Drop empty values in genus
observations <- observations[!(observations$genus==""),]

####################### Genera per Family Observations #######################################
observation_apidae_genera <- genus_simplifier(observations, family = "Apidae")
observation_colletidae_genera <- genus_simplifier(observations, family = "Colletidae")
observation_andrenidae_genera <- genus_simplifier(observations, family = "Andrenidae")
observation_halictidae_genera <- genus_simplifier(observations, family = "Halictidae")
observation_megachilidae_genera <- genus_simplifier(observations, family = "Megachilidae")
observation_melittidae_genera <- genus_simplifier(observations, family = "Melittidae")

####################### Create a vector of unique genera per family in observations ##########
nrow(observation_apidae_genera)
nrow(observation_colletidae_genera)
nrow(observation_andrenidae_genera)
nrow(observation_halictidae_genera)
nrow(observation_megachilidae_genera)
nrow(observation_melittidae_genera)

observations_generas_v <- c(29,2,6,13,18,1)

observations_genera_p_fams <- data.frame(bee_families, observations_generas_v)

###################### GGplot genera per family in Observations ###############################
ggplot(data = observations_genera_p_fams, aes(x = bee_families, y = observations_generas_v)) +
  geom_col() +
  xlab("Bee Family") +
  ylab("Unique Genera") +
  ggtitle("Genera Composition of Observations in California") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))
```

### Repeated for Unknowns
```{r}
# Drop empty values in genus
unknowns <- unknowns[!(unknowns$genus==""),]

####################### Genera per Family Observations #######################################
unknown_apidae_genera <- genus_simplifier(unknowns, family = "Apidae")
unknown_andrenidae_genera <- genus_simplifier(unknowns, family = "Andrenidae")
unknown_megachilidae_genera <- genus_simplifier(unknowns, family = "Megachilidae")
####################### Create a vector of unique genera per family in unknowns ##########
nrow(unknown_apidae_genera)
nrow(unknown_andrenidae_genera)
nrow(unknown_megachilidae_genera)

unk_fams <- c("Apidae", "Andrenidae", "Megachilidae")
unknown_generas_v <- c(1,1,1)

Unks_genera_p_fams <- data.frame(unk_fams, unknown_generas_v)

###################### GGplot genera per family in Observations ###############################
ggplot(data = Unks_genera_p_fams, aes(x = unk_fams, y = unknown_generas_v)) +
  geom_col() +
  xlab("Bee Family") +
  ylab("Unique Genera") +
  ggtitle("Genera Composition of Unknowns in California") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))
```

### Find unique number of species per family in Specimens
```{r}
species_simplifier <- function(data, family=NULL, unite = NULL, distincter=NULL){ #Make a species simplifier function
  if(!is.null(family)){
    data <- data[data$family %in% family,]
  }
  if(is.null(unite)) {
    data <- data %>%  unite(scientific_name, genus, specificEpithet, sep = " ", remove = FALSE)
  }
  if(is.null(distincter)){
    data <- data %>% 
      dplyr::group_by(scientific_name) %>% 
      dplyr::distinct(scientific_name, .keep_all=TRUE)
      
  }
}

specimens_epithet <- specimens[!(specimens$specificEpithet==""),] #Remove those observations that do not have a specific Epithet
############ Unique Species per family specimen ########################################################
specimens_apidae_species <- species_simplifier(specimens_epithet, family = "Apidae")
specimens_colletidae_species <-species_simplifier(specimens_epithet, family = "Colletidae")
specimens_andrenidae_species <- species_simplifier(specimens_epithet, family = "Andrenidae")
specimens_halictidae_species <- species_simplifier(specimens_epithet, family = "Halictidae")
specimens_megachilidae_species <- species_simplifier(specimens_epithet, family = "Megachilidae")
specimens_melittidae_species <- species_simplifier(specimens_epithet, family = "Melittidae")

############ finding the unique number of species per family ###########################################
nrow(specimens_apidae_species)
nrow(specimens_colletidae_species)
nrow(specimens_andrenidae_species)
nrow(specimens_halictidae_species)
nrow(specimens_megachilidae_species)
nrow(specimens_melittidae_species)

specimen_species <- c(454, 72, 549, 214, 430, 17)

specimen_species_df <- data.frame(bee_families, specimen_species)

############ GGploting the results #####################################################################
ggplot(data = specimen_species_df, aes(x = bee_families, y = specimen_species)) +
  geom_col() +
  xlab("Bee Family") +
  ylab("Unique Species") +
  ggtitle("Species Composition of Bee Specimens in California") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))
```
### Repeated for Observations
```{r}
observations_epithet <- observations[!(observations$specificEpithet==""),] #Remove those observations that do not have a specific Epithet
############ Unique Species per family specimen ########################################################
observations_apidae_species <- species_simplifier(observations_epithet, family = "Apidae")
observations_colletidae_species <-species_simplifier(observations_epithet, family = "Colletidae")
observations_andrenidae_species <- species_simplifier(observations_epithet, family = "Andrenidae")
observations_halictidae_species <- species_simplifier(observations_epithet, family = "Halictidae")
observations_megachilidae_species <- species_simplifier(observations_epithet, family = "Megachilidae")
observations_melittidae_species <- species_simplifier(observations_epithet, family = "Melittidae")

############ finding the unique number of species per family ###########################################
nrow(observations_apidae_species)
nrow(observations_colletidae_species)
nrow(observations_andrenidae_species)
nrow(observations_halictidae_species)
nrow(observations_megachilidae_species)
nrow(observations_melittidae_species)

observations_species <- c(101, 11, 37, 24, 59, 3)

observations_species_df <- data.frame(bee_families, observations_species)

############ GGploting the results #####################################################################
ggplot(data = observations_species_df, aes(x = bee_families, y = observations_species)) +
  geom_col() +
  xlab("Bee Family") +
  ylab("Unique Species") +
  ggtitle("Species Composition of Bee observations in California") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))
```

### Repeated for Unknowns 
```{r}
unknowns_epithet <- unknowns[!(unknowns$specificEpithet==""),] #Remove those unknowns that do not have a specific Epithet
############ Unique Species per family specimen ########################################################
unknowns_apidae_species <- species_simplifier(unknowns_epithet, family = "Apidae")

unknowns_andrenidae_species <- species_simplifier(unknowns_epithet, family = "Andrenidae")

unknowns_megachilidae_species <- species_simplifier(unknowns_epithet, family = "Megachilidae")


############ finding the unique number of species per family ###########################################
nrow(unknowns_apidae_species)

nrow(unknowns_andrenidae_species)

nrow(unknowns_megachilidae_species)


unknowns_species <- c(19, 66, 6)

unknowns_species_df <- data.frame(unk_fams, unknowns_species)

############ GGploting the results #####################################################################
ggplot(data = unknowns_species_df, aes(x = unk_fams, y = unknowns_species)) +
  geom_col() +
  xlab("Bee Family") +
  ylab("Unique Species") +
  ggtitle("Species Composition of Bee unknowns in California") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))
```

### Making dataframes to condense all types of genera per fam and species per fam into one 
```{r}
Bee_Families_Parent <- c("Apidae","Collentidae","Andrenidae","Halictidae","Megachilidae","Melittidae", "Apidae","Collentidae","Andrenidae","Halictidae","Megachilidae","Melittidae","Apidae","Andrenidae","Megachilidae" )

Basis_of_Record <- c("Specimens", "Specimens", "Specimens", "Specimens", "Specimens","Specimens", "Observations", "Observations","Observations","Observations","Observations","Observations", "Unknowns","Unknowns","Unknowns")

Genera_Record <- c(48,3,13,24,24,2,29,2,6,13,18,1,1,1,1)

Genera_Parent_df <- data.frame(Bee_Families_Parent, Basis_of_Record, Genera_Record)
```

### GGploting the Genera per Family on All Bases of Record
```{r}
library(calecopal) # Thank you An Bui! 

Genera_Plot <- ggplot(Genera_Parent_df, aes(x=Bee_Families_Parent, y = Genera_Record, fill = Basis_of_Record)) +
  geom_col(position = position_dodge2(preserve = "single")) +
  labs(fill = "Basis of Record") +
  xlab("Bee Family") +
  ylab("Number of Unique Genera") +
  ggtitle("Genera Composition of Bees in California") +
  theme_bw() +
  scale_fill_manual(values = cal_palette("sierra1")) +
  theme(plot.title = element_text( hjust = 0.5), 
        axis.text.x = element_text(angle = 45, hjust = 1))
  
  
```
### Making dataframes to condense all types of species per fam and species per fam into one 
```{r}
Species_Record <- c(454,72,549,214,430,17,101,11,37,24,59,3,19,66,6)

Species_Parent_df <- data.frame(Bee_Families_Parent, Basis_of_Record, Species_Record)
```

```{r}
Species_plot <- ggplot(Species_Parent_df, aes(x=Bee_Families_Parent, y = Species_Record, fill = Basis_of_Record)) +
  geom_col(position = position_dodge2(preserve = "single")) +
  labs(fill = "Basis of Record") +
  xlab("Bee Family") +
  ylab("Number of Unique Species") +
  ggtitle("Species Composition of Bees in California") +
  theme_bw() +
  scale_fill_manual(values = cal_palette("sierra1")) +
  theme(plot.title = element_text( hjust = 0.5), 
        axis.text.x = element_text(angle = 45, hjust = 1))
```

```{r}
### Lets arrange these plots together with ggpubr
library(ggpubr)

Species_Genera_Comparison <- ggarrange(Genera_Plot, Species_plot, ncol = 2, common.legend = TRUE, label.x =0.5 )

ggsave("Species_Genera_Visual_Comparison.jpeg", width = 10, height = 7, plot = Species_Genera_Comparison)
```
### Now lets evaluate how many genera and species there are recorded for specimens per institution 
```{r}
specimens_w_institution <- specimens %>% #Casewhen it to make the names a bit more readable for analysis
  mutate(Institution_Name = case_when(
    institutionCode == "USNM" ~ "Smithsonian Museum",
    institutionCode == "ASU" ~ "Arizona State University",
    institutionCode == "MCZ" ~ "Harvard University",
    institutionCode == "YPM" ~ "Princeton Peabody Museum",
    institutionCode == "" ~ "Unlisted",
    institutionCode == "LACM" ~ "Los Angeles Museum",
    institutionCode == "UMNH" ~ "Utah Museum",
    institutionCode == "UCSB" ~ " UC Santa Barbara",
    institutionCode == "TAMU" ~ "Texas A&M University",
    institutionCode == "CAS" ~ "California Academy of Sciences",
    institutionCode == "KU" ~ "University of Kansas",
    institutionCode == "USDA-ARS" ~ "US National Arboretum",
    institutionCode == "UCM" ~ "University of Colorado",
    institutionCode == "UA" ~ "University of Arizona",
    institutionCode == "TTU" ~ "Texas Tech Univsersity",
    institutionCode == "CASC" ~ "CASABIO",
    institutionCode == "PBDB" ~ "PaleoBiology Database",
    institutionCode == "SBMNH" ~ "Santa Barbara Museum",
    institutionCode == "C.A. Triplehorn Insect Collection, Ohio State University, Columbus, OH (OSUC)" ~ "Ohio State University",
    institutionCode == "VPI" ~ "Virginia Polytechnic Institute and University",
    institutionCode == "BISON" ~ "BISON",
    institutionCode == "CNC" ~ "Canadian National Collection",
    institutionCode == "UTE" ~ "University of Tartu",
    institutionCode == "SDNHM" ~ "San Diego Museum",
    institutionCode == "CSCA" ~ "California State Collection of Arthropods",
    institutionCode == "EMEC" ~ "Essig Museum of Entomology",
    institutionCode == "UCRC" ~ "UC Riverside",
    institutionCode == "UCSC" ~ "UC Santa Cruz",
    institutionCode == "University of Central Florida Collection of Arthopods (UCFC)" ~ "Central Florida University",
    institutionCode == "FMNH" ~ "Field Museum", 
    institutionCode == "UNHC" ~ "University of New Hampshire",
    institutionCode == "UTEP" ~ "UT El Paso",
    institutionCode == "UCD" ~ "UC Davis",
    institutionCode == "MSU" ~ "Michigan State University",
    institutionCode == "UTIC" ~ "UT Austin",
    institutionCode == "PSUC" ~ "Penn State University",
    institutionCode == "OSAC" ~ "Oregon State Arthropod Collection",
    institutionCode == "AUM" ~ "Auburn University",
    institutionCode == "KY" ~ "University of Kentucky",
    institutionCode == "UFPR" ~ "Universidade Federal do Parana",
    institutionCode == "AMNH" ~ "American Museum",
    institutionCode == "NAUF" ~ "Northern Arizona University",
    institutionCode == "Cleveland Museum of Natural History, OH (CLEV)" ~ "Cleveland Museum",
    institutionCode == "INHS" ~ "Illinois Natural History Survey",
    institutionCode == "NMSU" ~ "New Mexico State University", # Well this actually is the code for both New Mexico Uni and Northwest Missouri State Uni
    institutionCode == "UNM" ~ "University of New Mexico"
  )
  )
```





```{r}
### Sum up the number of genera per institution (unique)
institution_genera_summary <- specimens_w_institution %>% 
  group_by(Institution_Name) %>% 
  summarise(Unique_Genera_per_institution = n_distinct(genus))

specimens_w_institution_sci <-specimens_w_institution %>% 
  unite(scientific_name, genus, specificEpithet, sep = " ", remove = FALSE)


institution_species_summary <- specimens_w_institution_sci %>% 
  group_by(Institution_Name) %>% 
  summarise(Unique_species_per_institution = n_distinct(scientific_name) )



```

### Visualizing it with ggplot
```{r}

institution_pallette <- cal_palette("sierra1", n = 46, type = "continuous")

Institution_Genera_Summary_Plot <- ggplot(institution_genera_summary, aes(x=Institution_Name, y = Unique_Genera_per_institution, fill = Institution_Name)) +
  geom_col(position = position_dodge2(preserve = "single")) +
  labs(fill = "Institution") +
  xlab("Institution") +
  ylab("Number of Unique Genera Collected") +
  ggtitle("Unique Genera Specimen Collected By Institution in California") +
  theme_bw() +
  scale_fill_manual(values = cal_palette("sierra1", n = 46, type = "continuous")) +
  theme(plot.title = element_text( hjust = 0.5), 
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
  
Institution_Genera_Summary_Plot

Institution_Species_Summary_Plot <- ggplot(institution_species_summary, aes(x=Institution_Name, y = Unique_species_per_institution, fill = Institution_Name)) +
  geom_col(position = position_dodge2(preserve = "single")) +
  labs(fill = "Institution") +
  xlab("Institution") +
  ylab("Number of Unique Species Collected") +
  ggtitle("Unique Species Specimen Collected By Institution in California") +
  theme_bw() +
  scale_fill_manual(values = cal_palette("sierra1", n = 46, type = "continuous")) +
  theme(plot.title = element_text( hjust = 0.5), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none")

Institution_Species_Summary_Plot
  

```

### Repeated Institution Analysis for Observations type Data
```{r}
observations_w_institution <- observations %>% #Casewhen it to make the names a bit more readable for analysis
  mutate(Institution_Name = case_when(
    institutionCode == "USNM" ~ "Smithsonian Museum",
    institutionCode == "ASU" ~ "Arizona State University",
    institutionCode == "MCZ" ~ "Harvard University",
    institutionCode == "YPM" ~ "Princeton Peabody Museum",
    institutionCode == "" ~ "Unlisted",
    institutionCode == "LACM" ~ "Los Angeles Museum",
    institutionCode == "UMNH" ~ "Utah Museum",
    institutionCode == "UCSB" ~ " UC Santa Barbara",
    institutionCode == "TAMU" ~ "Texas A&M University",
    institutionCode == "CAS" ~ "California Academy of Sciences",
    institutionCode == "KU" ~ "University of Kansas",
    institutionCode == "USDA-ARS" ~ "US National Arboretum",
    institutionCode == "UCM" ~ "University of Colorado",
    institutionCode == "UA" ~ "University of Arizona",
    institutionCode == "TTU" ~ "Texas Tech Univsersity",
    institutionCode == "CASC" ~ "CASABIO",
    institutionCode == "PBDB" ~ "PaleoBiology Database",
    institutionCode == "SBMNH" ~ "Santa Barbara Museum",
    institutionCode == "C.A. Triplehorn Insect Collection, Ohio State University, Columbus, OH (OSUC)" ~ "Ohio State University",
    institutionCode == "VPI" ~ "Virginia Polytechnic Institute and University",
    institutionCode == "BISON" ~ "BISON",
    institutionCode == "CNC" ~ "Canadian National Collection",
    institutionCode == "UTE" ~ "University of Tartu",
    institutionCode == "SDNHM" ~ "San Diego Museum",
    institutionCode == "CSCA" ~ "California State Collection of Arthropods",
    institutionCode == "EMEC" ~ "Essig Museum of Entomology",
    institutionCode == "UCRC" ~ "UC Riverside",
    institutionCode == "UCSC" ~ "UC Santa Cruz",
    institutionCode == "University of Central Florida Collection of Arthopods (UCFC)" ~ "Central Florida University",
    institutionCode == "FMNH" ~ "Field Museum", 
    institutionCode == "UNHC" ~ "University of New Hampshire",
    institutionCode == "UTEP" ~ "UT El Paso",
    institutionCode == "UCD" ~ "UC Davis",
    institutionCode == "MSU" ~ "Michigan State University",
    institutionCode == "UTIC" ~ "UT Austin",
    institutionCode == "PSUC" ~ "Penn State University",
    institutionCode == "OSAC" ~ "Oregon State Arthropod Collection",
    institutionCode == "AUM" ~ "Auburn University",
    institutionCode == "KY" ~ "University of Kentucky",
    institutionCode == "UFPR" ~ "Universidade Federal do Parana",
    institutionCode == "AMNH" ~ "American Museum",
    institutionCode == "NAUF" ~ "Northern Arizona University",
    institutionCode == "Cleveland Museum of Natural History, OH (CLEV)" ~ "Cleveland Museum",
    institutionCode == "INHS" ~ "Illinois Natural History Survey",
    institutionCode == "NMSU" ~ "New Mexico State University", # Well this actually is the code for both New Mexico Uni and Northwest Missouri State Uni
    institutionCode == "UNM" ~ "University of New Mexico"
  )
  )


### Sum up the number of genera per institution (unique)
observations_institution_genera_summary <- observations_w_institution %>% 
  group_by(Institution_Name) %>% 
  summarise(Unique_Genera_per_institution = n_distinct(genus))

observations_w_institution_sci <-observations_w_institution %>% 
  unite(scientific_name, genus, specificEpithet, sep = " ", remove = FALSE)


observations_institution_species_summary <- observations_w_institution_sci %>% 
  group_by(Institution_Name) %>% 
  summarise(Unique_species_per_institution = n_distinct(scientific_name) )



```

### Visualizing it with ggplot for Observations per Institution 
```{r}

Obs_Institution_Genera_Summary_Plot <- ggplot(observations_institution_genera_summary, aes(x=Institution_Name, y = Unique_Genera_per_institution, fill = Institution_Name)) +
  geom_col(position = position_dodge2(preserve = "single")) +
  labs(fill = "Institution") +
  xlab("Institution") +
  ylab("Number of Unique Genera Collected") +
  ggtitle("Unique Genera Observations Collected By Institution in California") +
  theme_bw() +
  scale_fill_manual(values = cal_palette("sierra1", n = 46, type = "continuous")) +
  theme(plot.title = element_text( hjust = 0.5), 
        axis.text.x = element_text(angle = 45, hjust = 1),
        legend.position = "none")
  
Obs_Institution_Genera_Summary_Plot

Obs_Institution_Species_Summary_Plot <- ggplot(observations_institution_species_summary, aes(x=Institution_Name, y = Unique_species_per_institution, fill = Institution_Name)) +
  geom_col(position = position_dodge2(preserve = "single")) +
  labs(fill = "Institution") +
  xlab("Institution") +
  ylab("Number of Unique Species Collected") +
  ggtitle("Unique Species Observations Collected By Institution in California") +
  theme_bw() +
  scale_fill_manual(values = cal_palette("sierra1", n = 46, type = "continuous")) +
  theme(plot.title = element_text( hjust = 0.5), 
        axis.text.x = element_text(angle = 45, hjust = 1), 
        legend.position = "none")

Obs_Institution_Species_Summary_Plot
  

```



### Time series (Specimen)
```{r}

### Remove NA year
specimens2 <- specimens %>% 
  drop_na(year)
###
genera_time_summary <- specimens2 %>% 
  group_by(year) %>% 
  summarise(Unique_Genera_per_Year = n_distinct(genus))

specimens_w_scientific_name <- specimens2 %>% 
  unite(scientific_name, genus, specificEpithet, sep = " ", remove = FALSE)

species_time_unique_species_summary <- specimens_w_scientific_name %>%
  group_by(year) %>% 
  summarise(Unique_Species_per_Year = n_distinct(scientific_name))

species_time_totals_species_summary <- specimens_w_scientific_name %>% 
  group_by(year) %>% 
  summarise(n=n())
```


### Graph them (Specimen)
```{r}

genera_time_series <- ggplot(genera_time_summary, aes(x = year, y = Unique_Genera_per_Year)) +
  geom_line() +
  ggtitle("Number of Unique Specimen Genera Logged Each Year") +
  xlab("Time") +
  ylab("Number of Unique Genera") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))

genera_time_series

species_time_series <- ggplot(species_time_unique_species_summary, aes(x = year, y = Unique_Species_per_Year)) +
  geom_line() +
  ggtitle("Number of Unique Specimen Species Logged Each Year") +
  xlab("Time") +
  ylab("Number of Unique Species") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))

species_time_series

total_specimens_per_year <- ggplot(species_time_totals_species_summary, aes(x = year, y = n)) +
  geom_line() +
  ggtitle("Number of Specimens Logged Per Year") +
  xlab("Time") +
  ylab("Number of Specimens") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

total_specimens_per_year


```

### Time series (Observations)
```{r}

### Remove NA year
observations2 <- observations %>% 
  drop_na(year)
###
genera_time_summary_observations <- observations2 %>% 
  group_by(year) %>% 
  summarise(Unique_Genera_per_Year = n_distinct(genus))

observations_w_scientific_name <- observations2 %>% 
  unite(scientific_name, genus, specificEpithet, sep = " ", remove = FALSE)

observations_time_unique_species_summary <- observations_w_scientific_name %>%
  group_by(year) %>% 
  summarise(Unique_Species_per_Year = n_distinct(scientific_name))

observations_time_totals_species_summary <- observations_w_scientific_name %>% 
  group_by(year) %>% 
  summarise(n=n())
```


### Graph them (Observations)
```{r}

genera_time_series_observations <- ggplot(genera_time_summary_observations, aes(x = year, y = Unique_Genera_per_Year)) +
  geom_line() +
  ggtitle("Number of Unique Observation Genera Logged Each Year") +
  xlab("Time") +
  ylab("Number of Unique Genera") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))

genera_time_series_observations

observation_time_series <- ggplot(observation_time_unique_species_summary, aes(x = year, y = Unique_Species_per_Year)) +
  geom_line() +
  ggtitle("Number of Unique Observation Species Logged Each Year") +
  xlab("Time") +
  ylab("Number of Unique Species") +
  theme_bw() +
  theme(plot.title = element_text( hjust = 0.5))

observation_time_series

total_observations_per_year <- ggplot(observations_time_totals_species_summary, aes(x = year, y = n)) +
  geom_line() +
  ggtitle("Number of Specimens Logged Per Year") +
  xlab("Time") +
  ylab("Number of Specimens") +
  theme_bw() +
  theme(plot.title = element_text(hjust = 0.5))

total_observations_per_year


```

```{r eval=FALSE, include=FALSE}
# so take each genera and split it up to match each family 

Genera_per_fam <- function(data, family=NULL, counter=NULLL){
  if(!is.null(family)){
    data <- data$family[data$family == "family",] # subset out the data to only include the family of interest
  }
  if(is.null(counter)){
    count <- unique(data$genus) #Give only unique rows for the data set 
    l.count <- length(count) #
  }
  print(l.count)
}

for (i in unique(family$observations))
  Genera_per_fam(i, data = observations) # Probably dont do this since its not liking my for loop, we could us lapply instead.

# So genera/family & species/family in the observation/observation/unknown data sets?
```



