---
title: "Leaflet_maps"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# This document is focused on exploring the package leaflet in terms of our occurrence data. The goal is to integrate the filtering method into polygons on the interactive maps that leaflet offers, and then transition this to a shiny web application

```{r}
#Loading in packages
library(leaflet)
library(leaflet.extras)
library(rgdal)
library(sf)
library(raster)
```
### Bringing in the data
```{r}
copr_boundary <- readOGR("COPR_Boundary_2010/COPR_boundary2010.shp")
occurrence_data <- read.csv("occur5.csv")
specimen_data <- read.delim(file="occurrence.txt",header=TRUE)
copr_boundary_st <- st_read("COPR_Boundary_2010/COPR_boundary2010.shp")
```

### Putting the data in usable form for leaflet
```{r}
#Apparently the polygon shape file needs to be in the CRS of the occurrence data for this to work. 
copr_latlon <- spTransform(copr_boundary, CRS("+proj=longlat +datum=WGS84"))
```

```{r}
specimen_data_w_crs <- st_as_sf(specimen_data, coords = c('decimalLongitude', 'decimalLatitude'), crs = 4326) #Assigning the CRS to WGS84
```

```{r}
#Warning message was inquired on stackoverflow: https://stackoverflow.com/questions/57223853/how-to-apply-spatial-polygons-to-leaflet-map-using-shp 

copr_map <- sf::read_sf("COPR_Boundary_2010/COPR_boundary2010.shp") %>% 
  sf::st_transform('+proj=longlat +datum=WGS84') #this line of code is correct

specimen_bounded <- specimen_data_w_crs[copr_map,]

specimen_bounded_sep <- specimen_bounded %>%
  dplyr::mutate(decimalLatitude = sf::st_coordinates(.)[,2],
                decimalLongitude = sf::st_coordinates(.)[,1])

```
### Making a leaflet map
```{r}
map <- leaflet() %>% addTiles() %>% 
  addPolygons(data = copr_map, group = "Coal Oil Point Reserve") %>% 
  addCircleMarkers(data = specimen_bounded_sep, lat = ~decimalLatitude, lng = ~decimalLongitude, group = "Occurrence Data") %>% 
  #layer control
  addLayersControl(
    #baseGroups = "Occurrence Data", 
    overlayGroups = c("Coal Oil Point Reserve", "Occurrence Data"),
    options = layersControlOptions(collapsed = TRUE) 
  )

map

```


### Lets look at some of the info about our occurrence data.
```{r}
#Lets count up species richness
unique(specimen_bounded_sep$specificEpithet) #160 unique species

richness <- table(specimen_bounded_sep$specificEpithet) #This is the correct way to sum up the number of observations. 
richness
```



```{r}
#This line of code allows the user to view the map in clusters, meaning that the more you zoom in the more accurate each occurrence is logged.
map <- leaflet() %>% addTiles() %>% 
  addPolygons(data = copr_map, group = "Coal Oil Point Reserve") %>% 
  addMarkers(data = specimen_bounded_sep, lat = ~decimalLatitude, lng = ~decimalLongitude,clusterOptions = markerClusterOptions(),  group = "Occurrence Data") %>% 
  #layer control
  addLayersControl(
    #baseGroups = "Occurrence Data", 
    overlayGroups = c("Coal Oil Point Reserve", "Occurrence Data"),
    options = layersControlOptions(collapsed = TRUE) 
  )

map
```










## Lets write this to a .csv
```{r}
specimen_bounded_renamed <- specimen_bounded_sep %>% 
  dplyr::rename(latitude = decimalLatitude) %>%
  dplyr::rename(longitude = decimalLongitude)



specimen_bounded_renamed_condensed <- specimen_bounded_renamed[c(189:196,248,249)]

st_write(specimen_bounded_renamed_condensed, "C:/Users/jtmil/OneDrive/Desktop/CCBER/occurrence-maps/filter_polygon/leaflet_occurrence.csv",  layer_options = "GEOMETRY=AS_WKT")


write.table(specimen_bounded_renamed,file = "C:/Users/jtmil/OneDrive/Desktop/CCBER/occurrence-maps/filter_polygon/leaflet_occurrence.txt", sep="\t", row.names=FALSE )
```


### Lets see if we can make a heatmap for fun
```{r}
#This is reference to the stackexchange:https://gis.stackexchange.com/questions/168886/r-how-to-build-heatmap-with-the-leaflet-package
library(leaflet)
library(data.table)
library(sp)
library(rgdal)
library(KernSmooth)
library(raster)

#Possibly needs to be in data.table format?
specimen_data.table <- data.table::fread(file="C:/Users/jtmil/OneDrive/Desktop/CCBER/occurrence-maps/filter_polygon/leaflet_occurrence.txt",header=TRUE) 




#we need to make decimalLongitude and decimalLatitude renamed into just longitude and latitude 
#specimen_renamed <- specimen_data.table %>% 
  #dplyr::rename(latitude = decimalLatitude) %>%
  #dplyr::rename(longitude = decimalLongitude)

MASS::bandwidth.nrd(specimen_data.table$longitude)
MASS::bandwidth.nrd(specimen_data.table$latitude)


##Create a kernel density output
kde <- bkde2D(specimen_data.table[ , list(longitude, latitude)], 
              bandwidth = c(0.001480083, 0.002722569), gridsize = c(500,500))

##Create a Raster from kernel density output
KernelDensityRaster <- raster(list(x=kde$x1, y=kde$x2, z = kde$fhat))

##create pal function for coloring the raster
palRaster <- colorNumeric("Spectral", domain = KernelDensityRaster@data@values)
##Now leaflet map with the raster
leaflet() %>% 
  addPolygons(data = copr_map)%>% 
  addTiles() %>% 
  addRasterImage(KernelDensityRaster,
                 colors = palRaster,
                 opacity = 0.8) %>% 
  addLegend(pal = palRaster, 
            values = KernelDensityRaster@data@values, 
            title = "Kernel Density of Points")
```
```{r}
#Lets make this look a bit better
#Setting the density of low cells to NA
KernelDensityRaster@data@values[which(KernelDensityRaster@data@values < 1)] <- NA
#create another pal raster
palRaster <- colorNumeric("Spectral", domain = KernelDensityRaster@data@values, na.color = "transparent")

#Now redraw the map 
leaflet() %>% addTiles() %>% 
  addRasterImage(KernelDensityRaster, 
                 color = palRaster,
                 opacity = 0.8) %>% 
  addLegend(pal = palRaster,
            values = KernelDensityRaster@data@values,
            title = "Kernel Density of Points")
#This creates an okay kernel, however its odd that the density is so wide and large, probably needs some calibration, not to mention this needs to be cut down to the size of the shapefile. 
```
```{r}

```


 

```{r}
#This produces an unfiltered map that shows circle markers for all of the occurrence points

#I also added a layer control option that allows you to toggle on and off the polygon boundary layer. Still working on a solution to getting the data points to filter. https://rstudio.github.io/leaflet/showhide.html 
map <- leaflet() %>% addTiles() %>% 
  addPolygons(data = copr_latlon, group = "Coal Oil Point Reserve") %>% 
  addCircleMarkers(data = specimen_data, lat = ~decimalLatitude, lng = ~decimalLongitude, group = "Occurrence Data") %>% 
  #layer control
  addLayersControl(
    #baseGroups = "Occurrence Data", 
    overlayGroups = c("Coal Oil Point Reserve", "Occurrence Data"),
    options = layersControlOptions(collapsed = TRUE) 
  )

map

```

