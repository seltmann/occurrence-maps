---
title: "Polygon_Finalized"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# started by Katja Seltmann, 2020
# Script to map occurrence records of species (lat/long) that occur only within the boundaries of Coal Oil Point Reserve (shp file)
# COPR occurrence records in tab-delimited format: https://ucsb.box.com/s/7xp88xhg1xn7decsv0t3ll8du653deub
# COPR boundary files: https://ucsb.box.com/s/nd1s0e3ted8zsu0ir4wbxu7qpe94ht8o

#The goal of this script is to:
#draw boundary of copr on map
#Trim specimen_data (occurrence.txt) based on copr boundary creating new file that only contains specimens whose coordinates are within that boundary
```{r}
#required libraries
library(ggplot2)
library(sf)
library(raster)
library(rgdal)
library(dplyr)
library(tidyr)
library(plotly)
```

## Bringing in the data & cleaning
```{r}
#file that contains over 75K of specimen data with lat/long coordinates
specimen_data <- read.delim(file="occurrence.txt",header=TRUE)
```

```{r}
#remove rows where lat/long do not exist
specimen_data <- subset(specimen_data, !is.na(order) & !is.na(decimalLongitude) & !is.na(decimalLatitude))
```

```{r}
#This is showing us just the columns of data decimalLat, decimalLong, and order (taxonomic)

specimen_data_order <- specimen_data[c(134, 133, 194)]
```

```{r}
#read boundary from shp file
copr_boundary_2020 <- st_read("COPR_Boundary_2010/COPR_boundary2010.shp") #Vector type. 

copr_boundary_2020
#What is the projection of copr_boundary_2020

#Global datum is NAD83. California zone 5 is code: ESPG:2229.
```

## Drawing the boundary polygon
```{r}
#draw boundary from shp file
ggplot() +
  geom_sf(data = copr_boundary_2020, fill = "palegreen", color = "black")
```

## The CRSs (coordinate reference systems) of the boundary shp file and the occurence data are different, so we need to transform one into the other.
```{r}
#Technically the ESPG:4269 (NAD83) and ESPG:4326 (WGS84) are not equivalent, for most applications they can treated as equivalent. 

#First lets change the txt. data into a sf object that uses the standard crs = 4326 for latlong. 

occur_sf_order <- st_as_sf(specimen_data_order, coords = c('decimalLongitude', 'decimalLatitude'), crs = 4326)

#Now lets transform this new sf object to the crs using our boundary data 

occur_sf_order_new <- st_transform(occur_sf_order, 
                             st_crs(copr_boundary_2020))
#Check the extents, they appear to be in the same range 
extent(occur_sf_order_new)

extent(copr_boundary_2020)
```

## Now lets subset the data so that only data points that are within the copr_boundary are included. 
```{r}
#Now lets subset 

occur_sf_order_new_subset <- occur_sf_order_new[copr_boundary_2020,]
```

## Lets graph the transformed occurence data with the boundary polygon
```{r}
ggplot() +
  geom_sf(data = copr_boundary_2020, fill = "palegreen", color = "black") +
  geom_sf(occur_sf_order_new_subset, mapping = aes(geometry = geometry), size = 1) +
  ggtitle("Occurence of Plant Specimens within Coal Oil Point")

```

## Lets try making a nicer graph that shows taxonomic order in relation to the data points
```{r}
#Now lets graph by order.  

Order_Plot <- ggplot() +
                geom_sf(data = copr_boundary_2020, fill = "grey", color = "black") +
                geom_sf(occur_sf_order_new_subset, mapping = aes(geometry = geometry, color = order,)) +
                ggtitle("Distribution of identified organisms within Coal Oil Point") +
                labs( x = "Longitude", y = "Latitude") +
                theme_gray() +
                theme(legend.key.size = unit(0.5, "cm"), 
                axis.text = element_text(size = 7), 
                )

Order_Plot
```

## Lets try making an interactive plotly map so its easier to interpret 
```{r}
#Making an interactive map, where when you hover over each data point you may see the Taxonomic Order of the observed specimen. 
ggplotly(Order_Plot)
#Well we can make a hover map, however I think the end goal for this would be I want to show the number of observations at each given data point to show how many times that order was observed in that location. There are 98 unique observations while there is 1603 observations therefore there should be a large number of overlap. 
```

## Lets figure out a way to make it where we can get counts for each unique order with the same gps coordinate location so that we can see how many reaccurances appear in a location. 
```{r}
#Seems we need to seperate out the geometry column into new columns 

occurence_order_subset_sep <- occur_sf_order_new_subset %>%
  dplyr::mutate(lat = sf::st_coordinates(.)[,2],
                lon = sf::st_coordinates(.)[,1])
occurence_order_subset_sep
```

```{r}
#This is the correct way to sum up counts of the observations per coordinate point
occurence_order_subset_sep_unique <- occurence_order_subset_sep %>% 
  dplyr::group_by(lat, lon) %>% #Designate unique lat lon
  dplyr::mutate(count = n()) #Create a new column with the counts 
```

## Lets graph with both ggplot and ggplotly to see if the counts appear next to the data points. 
```{r}
#Now lets graph by order.  

Order_Plot4 <- ggplot() +
                geom_sf(data = copr_boundary_2020, fill = "grey", color = "black") +
                geom_sf(occurence_order_subset_sep_unique, mapping = aes(geometry = geometry,color = order, count = count)) +
                ggtitle("Distribution of identified organisms within Coal Oil Point") +
                labs( x = "Longitude", y = "Latitude") +
                theme_gray() +
                theme(legend.key.size = unit(0.5, "cm"), 
                axis.text = element_text(size = 7), 
                )

ggplotly(Order_Plot4, tooltip = c("order", "count"))
```

## Lets now try creating a heatmap of the data showing higher densities where the higher counts exist.
```{r}
#First lets create a subset of data that only looks at a specific order, Since hymenpotera has good representation and is a group of interest lets use that.
data_hymenpotera <-occurence_order_subset_sep_unique %>% 
  dplyr::filter(order == "Hymenoptera")
```


```{r}
ggplot() +
  geom_sf(data = copr_boundary_2020, fill = "grey", color = "black") +
  geom_density2d(data = data_hymenpotera, aes(x = lon, y = lat)) +
                 stat_density2d(data = data_hymenpotera, aes(x = lon, y = lat, fill = ..level..))

#Well this is kinda of what we're looking for, however the results are quite what we'd expect considering that there should be a high density region at the lower area of the map where there should be a count of 283. 
```



