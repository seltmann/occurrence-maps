---
title: "ecoregion_rarefaction_fine"
author: "JT Miller"
date: "4/13/2022"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## Necessary Libraries
```{r}
library(sf)
library(tidyverse)
library(taxize)
library(leaflet)
library(sqldf)
library(iNEXT)
```



## 1. Data pull from GBIF and AMNH
```{r}
# Read in the data from GBIF
specimen_data <- read.delim(file="D:/CCBER/Occurrence_Maps/Bee_diversity_research/Data/bee_occurrence_locality.txt",header=TRUE)

# Remove data that does not have an associated genus or specificEpithet
specimen_complete <- specimen_data %>% 
  filter(!(genus == "")) %>% 
  filter(!(specificEpithet == ""))

# Remove data that has more than 10 m of associated reference error
specimen_complete2 <- specimen_complete %>% 
  filter(!((locality == "[Not Stated]")& is.na(coordinateUncertaintyInMeters)))

specimen_complete3 <- specimen_complete2 %>% 
  filter(!((coordinateUncertaintyInMeters >= 100) & is.na(locality) | locality == "" | locality == "[state]" | locality == "[no specific locality data]"))




# Unite the genus and specificEpithet column to give a scientific name
specimen_data_SN  <- specimen_complete3 %>% 
  unite(scientific_name, genus, specificEpithet, sep = " ")

# Remove any empty occurrenceIDs and keep only distinct values
specimen_occur_IDed <- specimen_data_SN %>%
  dplyr::filter(!(occurrenceID == "")) %>% 
  dplyr::distinct(occurrenceID, .keep_all = TRUE)

# Remove any empty catalogeNumbers and keep only distinct values
specimen_occur_IDed_CatalogNumbered <- specimen_occur_IDed %>% 
  dplyr::filter(!(catalogNumber == "")) %>% 
  dplyr::distinct(catalogNumber, .keep_all = TRUE)

# Read in the data from AMNH
AMNH_specimens <- read.delim(file = "D:/CCBER/Occurrence_Maps/Bee_diversity_research/Data/AMNH_occurrences.tab", header = TRUE)

# Check
AMNH_specimens_t <- AMNH_specimens %>% 
  distinct(occurrenceID, .keep_all = TRUE) # These are equivalent, therefore no cleaning is needed on this dataset

# Filter out any empty values for the same fields as the GBIF pull, and keep only distinct values for OccurID and CatalogNumber
AMNH_specimens_complete <- AMNH_specimens %>%
  filter(!(genus == "")) %>% 
  filter(!(specificEpithet == "")) %>% 
  dplyr::filter(!(occurrenceID == "")) %>% 
  dplyr::distinct(occurrenceID, .keep_all = TRUE) %>% 
  dplyr::filter(!(catalogNumber == "")) %>% 
  dplyr::distinct(catalogNumber, .keep_all = TRUE)

# Create a scientific name column
AMNH_specimens_data_SN_complete  <- AMNH_specimens_complete %>% 
  unite(scientific_name, genus, specificEpithet, sep = " ")

# Remove any columns that aren't comparable between the two datasets
AMNH_specimens_simplified <- AMNH_specimens_data_SN_complete %>% 
  select(institutionCode, basisOfRecord,occurrenceID, catalogNumber, eventDate, year, month, day, decimalLatitude, decimalLongitude, georeferenceVerificationStatus, scientificName, kingdom, phylum, class, order, family, scientific_name, subgenus, coordinateUncertaintyInMeters, locality)

specimen_occur_less<- specimen_occur_IDed_CatalogNumbered %>% 
  select(!c(institutionID, verbatimCoordinateSystem))

combined_datasets_totals <- rbind(specimen_occur_less, AMNH_specimens_simplified) 

# NOTE: catalogNumber was again more inclusive, therefore the distinct was ran on it. 

combined_datasets_distinct_catalogNumber <- combined_datasets_totals %>% 
  dplyr::distinct(catalogNumber, .keep_all = TRUE) 
```

### 2. Taxize the data and Left join to find and replace taxonomic mistakes.
```{r}
# Make a variable that stores the sources that can be used in the global names database
sources <- gnr_datasources()

# Subset out the sources variable to only include the id for the Discover Life Bee Species Guide, set that to the variable 'Get_Disc_Life'
Get_Disc_Life <- sources$id[sources$title == 'Discover Life Bee Species Guide']

# Do the same thing but add ITIS as a second id
Get_Disc_Life_ITIS <- c(sources$id[sources$title == 'Discover Life Bee Species Guide'], sources$id[sources$title == 'Integrated Taxonomic Information SystemITIS'])

# 
unique_names <- combined_datasets_distinct_catalogNumber %>% 
  distinct(scientific_name, .keep_all = TRUE)

# Find the Corrected Names, use gnr_resolve to look at scientific name column and give resolved names based on the preferred source of Discover Life, and secondarily ITIS. Then change the scientific name to only include genus and specific Epithet using canonical = TRUE. 
Corrected_Names <- gnr_resolve(sci = unique_names$scientific_name, data_source_ids = Get_Disc_Life_ITIS, preferred_data_sources = Get_Disc_Life, resolve_once = TRUE, canonical = TRUE)

# Take Corrected_Names and remove any values for ____ that are 0.750 or below
Corrected_Names_r <- Corrected_Names %>% 
  filter(!(score == 0.750)) # Loses 38 Names that we are not confident in.

# Use a left join SQL query to correct the names in our dataset (THIS NEEDS TO BE UPDATED)
#  
left_joined_specimens <- sqldf("SELECT DISTINCT dataset.*, real_name_map.accepted_name
FROM combined_datasets_distinct_catalogNumber dataset 
LEFT JOIN (SELECT DISTINCT sub_dataset.scientific_name, MAX(sub_real_names.matched_name2) accepted_name
    FROM combined_datasets_distinct_catalogNumber sub_dataset
    LEFT JOIN Corrected_Names_r sub_real_names ON sub_dataset.scientific_name = sub_real_names.user_supplied_name
    GROUP BY sub_dataset.scientific_name) real_name_map ON dataset.scientific_name = real_name_map.accepted_name")


left_joined_specimens_dropped <- left_joined_specimens %>% 
  filter(!(is.na(accepted_name)))

```


### 3. The resulting dataset must be changed in a spatial type file and then parsed out to each ecoregion respectively. These Ecoregion Datasets will then be written to their own .csv files. 
```{r}
# Bring in 3rd level of Ecoregions by the EPA
eco_map <- sf::read_sf("filter_polygon/cali_ecoregions_3/ca_eco_l3.shp") %>% 
  sf::st_transform('+proj=longlat +datum=WGS84') 

colpal <- colorFactor(c("#00EDF4", "#F40000", "#D58400", "#139715", "#3740AE"), eco_map$L2_KEY)

colpal_ext <- colorFactor(c("#a6cee3", "#1f78b4", "#b2df8a", "#33a02c", "#fb9a99", "#e31a1c", "#fdbf6f", "#ff7f00", "#cab2d6", "#6a3d9a", "#ffff99", "#b15928"), eco_map$NA_L3NAME)

leaflet(eco_map) %>%
  addPolygons(stroke = FALSE, smoothFactor = 0.2, fillOpacity = 1,
              color = ~colpal_ext(NA_L3NAME)) %>% 
   addProviderTiles("Esri.WorldGrayCanvas") %>% 
  addLegend("bottomright", pal = colpal_ext, values = eco_map$NA_L3NAME)

# Remove anything without a lat lon coordinate 
bees_w_coords <- left_joined_specimens_dropped %>% 
  dplyr::filter(!is.na(decimalLatitude)|!is.na(decimalLongitude)) %>% 
  dplyr::filter(!(decimalLongitude == "")) %>% 
  dplyr::filter(!(decimalLatitude == ""))

bees_w_coords_w_crs <- st_as_sf(bees_w_coords, coords = c('decimalLongitude', 'decimalLatitude'), crs = 4326)

bees_bounded <- bees_w_coords_w_crs[eco_map,]

bees_bounded_sep <- bees_bounded %>%
  dplyr::mutate(decimalLatitude = sf::st_coordinates(.)[,2],
                decimalLongitude = sf::st_coordinates(.)[,1])

bees_bounded_sep2 <- bees_bounded_sep %>% 
  st_drop_geometry()

#write.csv(bees_bounded_sep2, "D:/CCBER/Occurrence_Maps/Bee_diversity_research/bees_combined_final.csv")



```

```{r}
### Parsing out the shapefiles 

#Seperating out the shapefile by ecoregions lvl 3
Coast_Range <- eco_map[1,]
Central_Basin_and_Range <- eco_map[2,]
Mojave_Basin_and_Range <- eco_map[3,]
Cascades <- eco_map[4,]
Sierra_Nevadas <- eco_map[5,]
Cali_Coastal_Sage_Chap_Oak_Woodlands1 <- eco_map[6,]
Central_Cali_Valley <- eco_map[7,]
Klamath_Mountains <- eco_map[8,]
Southern_and_Baja_Cali_PineOak_Mounts <- eco_map[9,]
Northern_Basin_and_Range <- eco_map[10,]
Sonoran_Desert <- eco_map[11,]
Cali_Coastal_Sage_Chap_Oak_Woodlands2 <- eco_map[12,]
Eastern_Cascades_Slopes_and_Foothills <- eco_map[13,]

# Subset the bees out by each of the ecoregion shapefiles
Coast_Range_Bees <- bees_bounded_sep[Coast_Range,]
Central_Basin_and_Range_Bees <- bees_bounded_sep[Central_Basin_and_Range,]
Mojave_Basin_and_Range_Bees <- bees_bounded_sep[Mojave_Basin_and_Range,]
Cascades_Bees <- bees_bounded_sep[Cascades,]
Sierra_Nevadas_Bees <- bees_bounded_sep[Sierra_Nevadas,]
Cali_Coastal_Sage_Chap_Oak_Woodlands1_Bees <- bees_bounded_sep[Cali_Coastal_Sage_Chap_Oak_Woodlands1,]
Central_Cali_Valley_Bees <- bees_bounded_sep[Central_Cali_Valley,]
Klamath_Mountains_Bees <- bees_bounded_sep[Klamath_Mountains,]
Southern_and_Baja_Cali_PineOak_Mounts_Bees <- bees_bounded_sep[Southern_and_Baja_Cali_PineOak_Mounts,]
Northern_Basin_and_Range_Bees <- bees_bounded_sep[Northern_Basin_and_Range,]
Sonoran_Desert_Bees <- bees_bounded_sep[Sonoran_Desert,]
Cali_Coastal_Sage_Chap_Oak_Woodlands2_Bees <- bees_bounded_sep[Cali_Coastal_Sage_Chap_Oak_Woodlands2,]
Eastern_Cascades_Slopes_and_Foothills_Bees <- bees_bounded_sep[Eastern_Cascades_Slopes_and_Foothills,]

#combining the Sage Chap Woodland regions since they are the same (?)
Cali_Coastal_Sage_Chap_Oak_Woodlands_Bees <- rbind(Cali_Coastal_Sage_Chap_Oak_Woodlands1_Bees, Cali_Coastal_Sage_Chap_Oak_Woodlands2_Bees)


```

```{r}
#install.packages("vegan")
library(vegan)
#install.packages("reshape")
library(reshape)

#Klamath_Mountains_Bees$ecoregion <- 'Klamath_Mountains' # Give the ecoregion a name
#Klamath_Mountains_Bees$weighted_value <- 1 # Create a value as a place holder just to say 'Hey this is 1 bee'
#Klamath_df <- as.data.frame(Klamath_Mountains_Bees) # Make it into a dataframe

#melted_data <- melt(Klamath_df, id = c(names(Klamath_df))) # Melt the data frame so we can reshape it

#site_reshaped <- reshape::cast(melted_data, accepted_name ~ ecoregion, value = 'weighted_value') # Reshape it 


#test <- Klamath_Mountains_Bees %>% 
  #filter(accepted_name == "Anthophora urbana") # Check it 

########################
#decostand(Klamath_Mountains_Bees$accepted_name, method = "pa")

########## Cut each dataset into 10 pieces?
interval <- function(x, cut = NULL){
  
  if(is.null(cut)){
    x <- x %>% mutate(count_cut_intervals = cut_interval(year, n = 10))
  }
}





Klamath_Mountains_Bees$ecoregion <- 'Klamath_Mountains' # Give the ecoregion a name
Coast_Range_Bees$ecoregion <- 'Coast_Range'
Central_Basin_and_Range_Bees$ecoregion <- 'Central_Basin_and_Range'
Mojave_Basin_and_Range_Bees$ecoregion <- 'Mojave_Basin_and_Range'
Cascades_Bees$ecoregion <- 'Cascades'
Sierra_Nevadas_Bees$ecoregion <- 'Sierra_Nevadas'
Cali_Coastal_Sage_Chap_Oak_Woodlands_Bees$ecoregion <- 'Cali_Coastal_Sage_Chap_Oak_Woodlands'
Central_Cali_Valley_Bees$ecoregion <- 'Central_Cali_Valley'
Southern_and_Baja_Cali_PineOak_Mounts_Bees$ecoregion <- 'Southern_and_Baja_Cali_PineOak_Mounts'
Northern_Basin_and_Range_Bees$ecoregion <- 'Northern_Basin_and_Range'
Sonoran_Desert_Bees$ecoregion <- 'Sonoran_Desert'
Eastern_Cascades_Slopes_and_Foothills_Bees$ecoregion <- 'Eastern_Cascades_Slopes_and_Foothills'

#Coast_Range_Bees_c <- interval(Coast_Range_Bees)


### Methodology update with help from Colleen 
qs <- 10 # Set up our quantiles 

KMB_drop <- Klamath_Mountains_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry() # Get rid of geometry now since it messes things up

KMB <- KMB_drop[order(KMB_drop$year),]
# order the dataframe in oldest to newest years

# Set up our quantiles for each set of years
yrs_KMB <- quantile(KMB$year, probs = seq(0,1,(1/qs)), type =2)

#put the bees into time periods: loop through the quantiles and assign each row in the famnh dataframe to a time period
KMB$bin<- NA

for(i in 1:qs){
  y<-yrs_KMB[i:(i+1)]
  if(i == 1) KMB[KMB$year >= y[1] & KMB$year <=y[2],]$bin <- i
  if(i != 1) KMB[KMB$year > y[1] & KMB$year <=y[2],]$bin <- i
}

# Reformatting the data, bins will be the rows and species will be the columns 

KMB_mat_set <-KMB %>% group_by(bin, accepted_name) %>% 
                          summarize(n=n()) %>% spread(accepted_name, n, fill=0)


KMB_mat <-as.data.frame(KMB_mat_set)[,-1]

# Reformat with bins as the columns and species as the rows for estimating coverage based rarefaction 
KMB_df = data.frame(t(KMB_mat))

# Getting the coverage estimates for each time period
KMB_cov = DataInfo(KMB_df)
range(KMB_cov$SC); mean(KMB_cov$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
KMB_list=lapply(KMB_df,as.vector)

#run the coverage-based rarefaction
out_KMB = estimateD(KMB_list, base="coverage",conf=NULL) 
colnames(out_KMB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

# Using formal iNEXT documentation methods 

KMB_i <- iNEXT(KMB_df, q=0, datatype="abundance")

ggiNEXT(KMB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

ChaoSpecies(KMB_df)

coverager <- function(Region_Bees, manual_qs){
  

    qs <- manual_qs
  

Region_drop <- Region_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry() # Get rid of geometry now since it messes things up

Region <- Region_drop[order(Region_drop$year),]
# order the dataframe in oldest to newest years

# Set up our quantiles for each set of years
yrs_Region <- quantile(Region$year, probs = seq(0,1,(1/qs)), type =2)

#put the bees into time periods: loop through the quantiles and assign each row in the famnh dataframe to a time period
Region$bin<- NA

for(i in 1:qs){
  y<-yrs_Region[i:(i+1)]
  if(i == 1) Region[Region$year >= y[1] & Region$year <=y[2],]$bin <- i
  if(i != 1) Region[Region$year > y[1] & Region$year <=y[2],]$bin <- i
}

# Reformatting the data, bins will be the rows and species will be the columns 

Region_mat_set <-Region %>% group_by(bin, accepted_name) %>% 
                          summarize(n=n()) %>% spread(accepted_name, n, fill=0)


Region_mat <-as.data.frame(Region_mat_set)[,-1]

# Reformat with bins as the columns and species as the rows for estimating coverage based rarefaction 
Region_df = data.frame(t(Region_mat))

return(Region_df)
}

#### Coverage based rarefaction for each ecoregion
KMB_df <- coverager(Klamath_Mountains_Bees, manual_qs = 10) # Klamath
CRB_df <- coverager(Coast_Range_Bees, manual_qs = 10) # Coast
MBRB_df <- coverager(Mojave_Basin_and_Range_Bees, manual_qs = 8)
CBRB_df <- coverager(Central_Basin_and_Range_Bees, manual_qs = 7)
CB_df <- coverager(Cascades_Bees, manual_qs = 8) # Cascades
SNB_df <- coverager(Sierra_Nevadas_Bees, manual_qs = 10) # Sierra Nevadas
CSHOB_df <- coverager(Cali_Coastal_Sage_Chap_Oak_Woodlands_Bees, manual_qs = 7)
CVB_df <- coverager(Central_Cali_Valley_Bees, manual_qs = 8) 
SBB_df <- coverager(Southern_and_Baja_Cali_PineOak_Mounts_Bees, manual_qs = 10)
NBRB_df <- coverager(Northern_Basin_and_Range_Bees, manual_qs = 2)
SDB_df <- coverager(Sonoran_Desert_Bees, manual_qs = 10)
ECSB_df <- coverager(Eastern_Cascades_Slopes_and_Foothills_Bees, manual_qs = 10)


```

### Now use estimateD for the ecoregions

# Chapparal
```{r}
# Getting the coverage estimates for each time period
CSHOB_coverage = DataInfo(CSHOB_df)
range(CSHOB_coverage$SC); mean(CSHOB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
CSHOB_list=lapply(CSHOB_df,as.vector)

#run the coverage-based rarefaction
out_CSHOB = estimateD(CSHOB_list, base="coverage",conf=NULL) 
colnames(out_CSHOB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_CSHOB)

CSHOB_i <- iNEXT(CSHOB_df, q=0, datatype="abundance")

print(CSHOB_i)

ggiNEXT(CSHOB_i, type=2, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that there is a Sample coverage output of 98.5%
```

# Mojave
```{r}
# Getting the coverage estimates for each time period
MBRB_coverage = DataInfo(MBRB_df)
range(MBRB_coverage$SC); mean(MBRB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
MBRB_list=lapply(MBRB_df,as.vector)

#run the coverage-based rarefaction
out_MBRB = estimateD(MBRB_list, base="coverage",conf=NULL) 
colnames(out_MBRB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_MBRB)

MBRB_i <- iNEXT(MBRB_df, q=0, datatype="abundance")

print(MBRB_i)

ggiNEXT(MBRB_i, type=2, se=TRUE, facet.var="none", color.var="site", grey=FALSE)


### Seems that the Sample Coverage is 93.8%
```

# Klamath 
```{r}
# Getting the coverage estimates for each time period
KMB_coverage = DataInfo(KMB_df)
range(KMB_coverage$SC); mean(KMB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
KMB_list=lapply(KMB_df,as.vector)

#run the coverage-based rarefaction
out_KMB = estimateD(KMB_list, base="coverage",conf=NULL) 
colnames(out_KMB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_KMB)

KMB_i <- iNEXT(KMB_df, q=0, datatype="abundance")

print(KMB_i)

ggiNEXT(KMB_i, type=2, se=TRUE, facet.var="none", color.var="site", grey=FALSE)


### Seems that the Sample Coverage is 86%
```

# Coast Range  
```{r}
# Getting the coverage estimates for each time period
CRB_coverage = DataInfo(CRB_df)
range(CRB_coverage$SC); mean(CRB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
CRB_list=lapply(CRB_df,as.vector)

#run the coverage-based rarefaction
out_CRB = estimateD(CRB_list, base="coverage",conf=NULL) 
colnames(out_CRB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_CRB)


CRB_i <- iNEXT(CRB_df, q=0, datatype="abundance")

print(CRB_i)

ggiNEXT(CRB_i, type=2, se=TRUE, facet.var="none", color.var="site", grey=FALSE)


### Seems that the Sample Coverage is 93.5%
```

# Central Basin and Range 
```{r}
# Getting the coverage estimates for each time period
CBRB_coverage = DataInfo(CBRB_df)
range(CBRB_coverage$SC); mean(CBRB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
CBRB_list=lapply(CBRB_df,as.vector)

#run the coverage-based rarefaction
out_CBRB = estimateD(CBRB_list, base="coverage",conf=NULL) 
colnames(out_CBRB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_CBRB)

CBRB_i <- iNEXT(CBRB_df, q=0, datatype="abundance")

print(CBRB_i)

ggiNEXT(CBRB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that the Sample Coverage is 77.5%
```

# Cascades
```{r}
# Getting the coverage estimates for each time period
CB_coverage = DataInfo(CB_df)
range(CB_coverage$SC); mean(CB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
CB_list=lapply(CB_df,as.vector)

#run the coverage-based rarefaction
out_CB = estimateD(CB_list, base="coverage",conf=NULL) 
colnames(out_CB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_CB)

CB_i <- iNEXT(CB_df, q=0, datatype="abundance")

print(CB_i)

ggiNEXT(CB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that the Sample Coverage is 79.3%

# It should be noted this looks to be weighted, the beginning has 0.09% coverage compared to the <98% later on
```

# Sierra Nevadas
```{r}
# Getting the coverage estimates for each time period
SNB_coverage = DataInfo(SNB_df)
range(SNB_coverage$SC); mean(SNB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
SNB_list=lapply(SNB_df,as.vector)

#run the coverage-based rarefaction
out_SNB = estimateD(SNB_list, base="coverage",conf=NULL) 
colnames(out_SNB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_SNB)

SNB_i <- iNEXT(SNB_df, q=0, datatype="abundance")

print(SNB_i)

ggiNEXT(SNB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that the Sample Coverage is 93.5%


```

# Central Valley
```{r}
# Getting the coverage estimates for each time period
CVB_coverage = DataInfo(CVB_df)
range(CVB_coverage$SC); mean(CVB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
CVB_list=lapply(CVB_df,as.vector)

#run the coverage-based rarefaction
out_CVB = estimateD(CVB_list, base="coverage",conf=NULL) 
colnames(out_CVB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_CVB)

CVB_i <- iNEXT(CVB_df, q=0, datatype="abundance")

print(CVB_i)

ggiNEXT(CVB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that the Sample Coverage is 94.6%


```

# Southern Bajas
```{r}
# Getting the coverage estimates for each time period
SBB_coverage = DataInfo(SBB_df)
range(SBB_coverage$SC); mean(SBB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
SBB_list=lapply(SBB_df,as.vector)

#run the coverage-based rarefaction
out_SBB = estimateD(SBB_list, base="coverage",conf=NULL) 
colnames(out_SBB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_SBB)

SBB_i <- iNEXT(SBB_df, q=0, datatype="abundance")

print(SBB_i)

ggiNEXT(SBB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that the Sample Coverage is 92.7%


```

# Northern Basin 
```{r}
# Getting the coverage estimates for each time period
NBRB_coverage = DataInfo(NBRB_df)
range(NBRB_coverage$SC); mean(NBRB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
NBRB_list=lapply(NBRB_df,as.vector)

#run the coverage-based rarefaction
out_NBRB = estimateD(NBRB_list, base="coverage",conf=NULL) 
colnames(out_NBRB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_NBRB)

NBRB_i <- iNEXT(NBRB_df, q=0, datatype="abundance")

print(NBRB_i)

ggiNEXT(NBRB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that the Sample Coverage is 87.9%


```

# Sonoran Desert
```{r}
# Getting the coverage estimates for each time period
SDB_coverage = DataInfo(SDB_df)
range(SDB_coverage$SC); mean(SDB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
SDB_list=lapply(SDB_df,as.vector)

#run the coverage-based rarefaction
out_SDB = estimateD(SDB_list, base="coverage",conf=NULL) 
colnames(out_SDB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_SDB)

SDB_i <- iNEXT(SDB_df, q=0, datatype="abundance")

print(SDB_i)

ggiNEXT(SDB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that the Sample Coverage is 81.7%


```

# Eastern Cascades
```{r}
# Getting the coverage estimates for each time period
ECSB_coverage = DataInfo(ECSB_df)
range(ECSB_coverage$SC); mean(ECSB_coverage$SC)

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
ECSB_list=lapply(ECSB_df,as.vector)

#run the coverage-based rarefaction
out_ECSB = estimateD(ECSB_list, base="coverage",conf=NULL) 
colnames(out_ECSB) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

print(out_ECSB)

ECSB_i <- iNEXT(ECSB_df, q=0, datatype="abundance")

print(ECSB_i)

ggiNEXT(ECSB_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

### Seems that the Sample Coverage is 83%


```

### Summarizing the outputs in an easier to read format
```{r}
range(KMB_coverage$SC); mean(KMB_coverage$SC)
### 91.9%
range(CRB_coverage$SC); mean(CRB_coverage$SC)
### 97.2%
range(MBRB_coverage$SC); mean(MBRB_coverage$SC)
### 96.9%
range(CBRB_coverage$SC); mean(CBRB_coverage$SC)
### 89.5%
range(CB_coverage$SC); mean(CB_coverage$SC)
### 91.1%
range(SNB_coverage$SC); mean(SNB_coverage$SC)
### 96.6%
range(CSHOB_coverage$SC); mean(CSHOB_coverage$SC)
### 99.3%
range(CVB_coverage$SC); mean(CVB_coverage$SC)
### 97.0%
range(SBB_coverage$SC); mean(SBB_coverage$SC)
### 96.0%
range(NBRB_coverage$SC); mean(NBRB_coverage$SC)
### 88.3%
range(SDB_coverage$SC); mean(SDB_coverage$SC)
### 92.9%
range(ECSB_coverage$SC); mean(ECSB_coverage$SC)
### 83.0%


### AND 

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
KMB_list=lapply(KMB_df,as.vector)

#run the coverage-based rarefaction
out_KMB = estimateD(regions_list, base="coverage",conf=NULL) 
colnames(out_regions) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
regions_list=lapply(regions_df,as.vector)

#run the coverage-based rarefaction
out_regions = estimateD(regions_list, base="coverage",conf=NULL) 
colnames(out_regions) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

### Lets conduct rarefaction all of the ecoregions first 

# Bring the regions all back together, get rid of geometry and the missing years
```

```{r}

CRB_drop <- Coast_Range_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
MBRB_drop <- Mojave_Basin_and_Range_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
CBRB_drop <- Central_Basin_and_Range_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
CB_drop <- Cascades_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
SNB_drop <- Sierra_Nevadas_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
CSHOB_drop <- Cali_Coastal_Sage_Chap_Oak_Woodlands_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
CVB_drop <- Central_Cali_Valley_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
SBB_drop <- Southern_and_Baja_Cali_PineOak_Mounts_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
NBRB_drop <- Northern_Basin_and_Range_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
SDB_drop <- Sonoran_Desert_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()
ECSB_drop <- Eastern_Cascades_Slopes_and_Foothills_Bees %>% 
  filter(!is.na(year)) %>%  # Get rid of any bees without a year
  st_drop_geometry()

regions_bees <- rbind(KMB_drop, CRB_drop, MBRB_drop, CBRB_drop, CB_drop, SNB_drop, CSHOB_drop, CVB_drop, SBB_drop, NBRB_drop, SDB_drop, ECSB_drop)

```

### Now create the appropriate data for iNEXT abundance.
```{r}
regions_mat_set <-regions_bees %>% group_by(ecoregion, accepted_name) %>% 
                          summarize(n=n()) %>% spread(accepted_name, n, fill=0)


regions_mat <-as.data.frame(regions_mat_set)[,-1]

# Reformat with bins as the columns and species as the rows for estimating coverage based rarefaction 
regions_df = data.frame(t(regions_mat))

colnames(regions_df) <- c("Chaparral","Cascades","Central Basin", "Central Valley", "Coast Range", "Eastern Cascades", "Klamath Mountains","Mojave", "Northern Basin","Sierra Nevadas", "Sonoran Desert", "Baja California")

regions_i <- iNEXT(regions_df, q=0, datatype="abundance")


print(regions_i)

ggiNEXT(regions_i, type=3, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

ggiNEXT(regions_i, type=2, se=TRUE, facet.var="none", color.var="site", grey=FALSE)

ggiNEXT(regions_i, type=1, se=TRUE, facet.var="none", color.var="site", grey=FALSE) 


regions_coverage = DataInfo(regions_df)


range(regions_coverage$SC); mean(regions_coverage$SC)
# The mean is 97.5%

#now estiamte richness using coverage-based rarefaction
#reformat again - make a list,of the species abundance distributions in each time period - 
# this is the format needed for using coverage-based rarefaction
regions_list=lapply(regions_df,as.vector)

#run the coverage-based rarefaction
out_regions = estimateD(regions_list, base="coverage",conf=NULL) 
colnames(out_regions) = c("Xbin","m","method","SC","rar_rich","rar_shan","rar_simp")

ecoregion_richness <- ChaoRichness(regions_df, datatype = "abundance")

ecoregion_richness_df <- data.frame(ecoregion_richness)

```

```{r}
ecoregion_naming <- c("Chaparral", "Cascades", "Central Basin", "Central Valley", "Coast Range", "Eastern Cascades", "Klamath Mountains", "Mojave", "Northern Basin", "Sierra Nevadas", "Sonoran Desert", "Baja")

ecoregion_richness_p <-cbind(ecoregion_richness, ecoregion_naming)

ecoregion_richness_p %>% 
  dplyr::rename(U = '95% Upper')

library(calecopal)

ggplot(ecoregion_richness_p, mapping =aes(x = ecoregion_naming, y = Estimator, fill = ecoregion_naming)) +
  geom_col() +
  theme_bw() +
  scale_fill_manual(values = cal_palette("sierra1", n = 12, type = "continuous")) +
  geom_errorbar(aes(ymin = 95% Lower, ymax = 95% Upper),
                width = 0.2,
                position = position_dodge(width = 0.5),
                color="black", size=1) +
  theme(axis.text.x = element_text(angle = 45, hjust = 1),
        plot.title = element_text( hjust = 0.5)) 
```

